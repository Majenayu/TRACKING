<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProximityTracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsencrypt/3.3.2/jsencrypt.min.js"></script>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-core.js"></script>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-service.js"></script>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-ui.js"></script>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js"></script>
    <link rel="stylesheet" type="text/css" href="https://js.api.here.com/v3/3.1/mapsjs-ui.css" />
    <style>
        .pulse-animation {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="max-w-md mx-auto bg-white min-h-screen">
        <!-- Header -->
        <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 text-center">
            <h1 class="text-2xl font-bold">ProximityTracker</h1>
            <p class="text-blue-100 mt-2">Secure Location Sharing</p>
        </header>

        <!-- Mode Toggle -->
        <div class="p-4 bg-gray-50 border-b">
            <div class="flex rounded-lg bg-gray-200 p-1">
                <button id="sender-mode" class="flex-1 py-2 px-4 text-sm font-medium rounded-md bg-blue-600 text-white transition-colors">
                    Sender Mode
                </button>
                <button id="receiver-mode" class="flex-1 py-2 px-4 text-sm font-medium rounded-md text-gray-700 hover:bg-gray-100 transition-colors">
                    Receiver Mode
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <main class="p-4">
            <!-- Sender Interface -->
            <div id="sender-interface" class="space-y-4">
                <div class="bg-white rounded-lg shadow p-4">
                    <h2 class="text-lg font-semibold mb-4">Share Your Location</h2>
                    
                    <!-- Key Generation -->
                    <div class="mb-4">
                        <button id="generate-keys" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                            Generate Security Keys
                        </button>
                        <p class="text-sm text-gray-600 mt-2">Generate RSA keys for secure location sharing</p>
                    </div>

                    <!-- Sender ID Display -->
                    <div id="sender-id-display" class="hidden bg-blue-50 p-3 rounded-lg mb-4">
                        <p class="text-sm text-gray-700">Your Sender ID:</p>
                        <p id="sender-id" class="font-mono text-lg font-bold text-blue-600"></p>
                        <p class="text-xs text-gray-500 mt-1">Share this ID with the receiver</p>
                    </div>

                    <!-- Location Sharing Controls -->
                    <div class="space-y-3">
                        <button id="start-sharing" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50" disabled>
                            Start Sharing Location
                        </button>
                        <button id="stop-sharing" class="w-full bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors hidden">
                            Stop Sharing Location
                        </button>
                    </div>

                    <!-- Status Display -->
                    <div id="sharing-status" class="hidden mt-4 p-3 rounded-lg">
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-green-500 rounded-full mr-3 pulse-animation"></div>
                            <span class="text-sm text-gray-700">Sharing location securely...</span>
                        </div>
                    </div>
                </div>

                <!-- Current Location Info -->
                <div id="location-info" class="hidden bg-white rounded-lg shadow p-4">
                    <h3 class="font-semibold mb-2">Current Location</h3>
                    <div class="text-sm text-gray-600 space-y-1">
                        <p>Latitude: <span id="current-lat">-</span></p>
                        <p>Longitude: <span id="current-lng">-</span></p>
                        <p>Accuracy: <span id="current-accuracy">-</span>m</p>
                        <p>Last Updated: <span id="last-updated">-</span></p>
                    </div>
                </div>
            </div>

            <!-- Receiver Interface -->
            <div id="receiver-interface" class="space-y-4 hidden">
                <div class="bg-white rounded-lg shadow p-4">
                    <h2 class="text-lg font-semibold mb-4">Track Someone's Location</h2>
                    
                    <!-- Sender ID Input -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Sender ID</label>
                        <input type="text" id="receiver-sender-id" placeholder="Enter sender ID" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- Tracking Controls -->
                    <div class="space-y-3">
                        <button id="start-tracking" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                            Start Tracking
                        </button>
                        <button id="stop-tracking" class="w-full bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors hidden">
                            Stop Tracking
                        </button>
                    </div>

                    <!-- Distance Display -->
                    <div id="distance-display" class="hidden mt-4 p-3 rounded-lg">
                        <div class="text-center">
                            <div class="text-3xl font-bold text-blue-600" id="distance-value">-</div>
                            <div class="text-sm text-gray-600">meters away</div>
                        </div>
                    </div>

                    <!-- Proximity Alert -->
                    <div id="proximity-alert" class="hidden mt-4 p-3 bg-orange-100 border border-orange-300 rounded-lg">
                        <div class="flex items-center">
                            <div class="w-3 h-3 bg-orange-500 rounded-full mr-3 pulse-animation"></div>
                            <span class="text-sm text-orange-700">You are within 1km of the sender!</span>
                        </div>
                    </div>
                </div>

                <!-- Map Container -->
                <div id="map-container" class="hidden bg-white rounded-lg shadow overflow-hidden">
                    <div id="here-map" class="w-full h-64"></div>
                </div>

                <!-- Location Details -->
                <div id="tracking-info" class="hidden bg-white rounded-lg shadow p-4">
                    <h3 class="font-semibold mb-2">Tracking Information</h3>
                    <div class="text-sm text-gray-600 space-y-1">
                        <p>Sender Latitude: <span id="sender-lat">-</span></p>
                        <p>Sender Longitude: <span id="sender-lng">-</span></p>
                        <p>Your Latitude: <span id="receiver-lat">-</span></p>
                        <p>Your Longitude: <span id="receiver-lng">-</span></p>
                        <p>Last Updated: <span id="tracking-updated">-</span></p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Notifications -->
        <div id="notifications" class="fixed bottom-4 right-4 space-y-2 z-50"></div>
    </div>

    <script>
        // Global variables
        let currentMode = 'sender';
        let senderKeys = null;
        let senderId = null;
        let isSharing = false;
        let isTracking = false;
        let sharingInterval = null;
        let trackingInterval = null;
        let hereMap = null;
        let mapInitialized = false;

        // HERE Maps API key (demo key - replace with your own)
        const HERE_API_KEY = 'demo-key';

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            setupModeToggle();
            setupSenderInterface();
            setupReceiverInterface();
            showNotification('Welcome to ProximityTracker! Generate keys to start sharing your location.', 'info');
        });

        // Mode toggle functionality
        function setupModeToggle() {
            document.getElementById('sender-mode').addEventListener('click', () => switchMode('sender'));
            document.getElementById('receiver-mode').addEventListener('click', () => switchMode('receiver'));
        }

        function switchMode(mode) {
            currentMode = mode;
            
            // Update button styles
            if (mode === 'sender') {
                document.getElementById('sender-mode').className = 'flex-1 py-2 px-4 text-sm font-medium rounded-md bg-blue-600 text-white transition-colors';
                document.getElementById('receiver-mode').className = 'flex-1 py-2 px-4 text-sm font-medium rounded-md text-gray-700 hover:bg-gray-100 transition-colors';
                document.getElementById('sender-interface').classList.remove('hidden');
                document.getElementById('receiver-interface').classList.add('hidden');
            } else {
                document.getElementById('sender-mode').className = 'flex-1 py-2 px-4 text-sm font-medium rounded-md text-gray-700 hover:bg-gray-100 transition-colors';
                document.getElementById('receiver-mode').className = 'flex-1 py-2 px-4 text-sm font-medium rounded-md bg-blue-600 text-white transition-colors';
                document.getElementById('sender-interface').classList.add('hidden');
                document.getElementById('receiver-interface').classList.remove('hidden');
            }
        }

        // Sender interface setup
        function setupSenderInterface() {
            document.getElementById('generate-keys').addEventListener('click', generateKeys);
            document.getElementById('start-sharing').addEventListener('click', startLocationSharing);
            document.getElementById('stop-sharing').addEventListener('click', stopLocationSharing);
        }

        async function generateKeys() {
            try {
                showNotification('Generating RSA keys...', 'info');
                
                // Generate RSA key pair
                const crypt = new JSEncrypt({default_key_size: 2048});
                crypt.getKey();
                
                senderKeys = {
                    public: crypt.getPublicKey(),
                    private: crypt.getPrivateKey()
                };
                
                // Generate unique sender ID
                senderId = 'sender_' + Math.random().toString(36).substr(2, 9);
                
                // Store keys on server
                const response = await fetch('/api/keys', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        senderId: senderId,
                        publicKey: senderKeys.public,
                        privateKey: senderKeys.private
                    })
                });
                
                if (response.ok) {
                    // Show sender ID
                    document.getElementById('sender-id').textContent = senderId;
                    document.getElementById('sender-id-display').classList.remove('hidden');
                    document.getElementById('start-sharing').disabled = false;
                    
                    showNotification('Keys generated successfully! Share your Sender ID with the receiver.', 'success');
                } else {
                    throw new Error('Failed to store keys');
                }
                
            } catch (error) {
                console.error('Error generating keys:', error);
                showNotification('Failed to generate keys. Please try again.', 'error');
            }
        }

        async function startLocationSharing() {
            if (!senderKeys || !senderId) {
                showNotification('Please generate keys first', 'error');
                return;
            }

            try {
                // Request location permission
                const position = await getCurrentPosition();
                
                isSharing = true;
                document.getElementById('start-sharing').classList.add('hidden');
                document.getElementById('stop-sharing').classList.remove('hidden');
                document.getElementById('sharing-status').classList.remove('hidden');
                document.getElementById('location-info').classList.remove('hidden');
                
                // Start sharing location every 2 seconds
                sharingInterval = setInterval(shareLocation, 2000);
                shareLocation(); // Share immediately
                
                showNotification('Started sharing location securely', 'success');
                
            } catch (error) {
                console.error('Error starting location sharing:', error);
                showNotification('Failed to access location. Please enable location services.', 'error');
            }
        }

        async function shareLocation() {
            try {
                const position = await getCurrentPosition();
                const { latitude, longitude, accuracy } = position.coords;
                
                // Update UI
                document.getElementById('current-lat').textContent = latitude.toFixed(6);
                document.getElementById('current-lng').textContent = longitude.toFixed(6);
                document.getElementById('current-accuracy').textContent = accuracy.toFixed(0);
                document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
                
                // Encrypt location data
                const locationData = JSON.stringify({
                    latitude: latitude,
                    longitude: longitude,
                    accuracy: accuracy,
                    timestamp: Date.now()
                });
                
                const crypt = new JSEncrypt();
                crypt.setPublicKey(senderKeys.public);
                const encryptedData = crypt.encrypt(locationData);
                
                // Send to server
                const response = await fetch('/api/location', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        senderId: senderId,
                        encryptedData: encryptedData,
                        publicKey: senderKeys.public,
                        timestamp: Date.now()
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to share location');
                }
                
            } catch (error) {
                console.error('Error sharing location:', error);
                showNotification('Failed to share location', 'error');
            }
        }

        function stopLocationSharing() {
            isSharing = false;
            if (sharingInterval) {
                clearInterval(sharingInterval);
                sharingInterval = null;
            }
            
            document.getElementById('start-sharing').classList.remove('hidden');
            document.getElementById('stop-sharing').classList.add('hidden');
            document.getElementById('sharing-status').classList.add('hidden');
            
            showNotification('Stopped sharing location', 'info');
        }

        // Receiver interface setup
        function setupReceiverInterface() {
            document.getElementById('start-tracking').addEventListener('click', startTracking);
            document.getElementById('stop-tracking').addEventListener('click', stopTracking);
        }

        async function startTracking() {
            const inputSenderId = document.getElementById('receiver-sender-id').value.trim();
            
            if (!inputSenderId) {
                showNotification('Please enter a sender ID', 'error');
                return;
            }
            
            try {
                // Get receiver's location
                const receiverPosition = await getCurrentPosition();
                
                isTracking = true;
                document.getElementById('start-tracking').classList.add('hidden');
                document.getElementById('stop-tracking').classList.remove('hidden');
                document.getElementById('distance-display').classList.remove('hidden');
                document.getElementById('tracking-info').classList.remove('hidden');
                
                // Initialize map
                if (!mapInitialized) {
                    initializeMap();
                }
                
                // Start tracking every 2 seconds
                trackingInterval = setInterval(() => trackLocation(inputSenderId, receiverPosition), 2000);
                trackLocation(inputSenderId, receiverPosition); // Track immediately
                
                showNotification('Started tracking location', 'success');
                
            } catch (error) {
                console.error('Error starting tracking:', error);
                showNotification('Failed to start tracking. Please check sender ID and try again.', 'error');
            }
        }

        async function trackLocation(senderId, receiverPosition) {
            try {
                // Get current receiver position
                const currentReceiverPos = await getCurrentPosition();
                
                // Fetch sender's encrypted location
                const response = await fetch(`/api/location/${senderId}`);
                if (!response.ok) {
                    throw new Error('Sender not found or not sharing location');
                }
                
                const data = await response.json();
                
                // Get sender's private key for decryption
                const keysResponse = await fetch(`/api/keys/${senderId}`);
                if (!keysResponse.ok) {
                    throw new Error('Keys not found');
                }
                
                const keysData = await keysResponse.json();
                
                // Decrypt location data
                const crypt = new JSEncrypt();
                crypt.setPrivateKey(keysData.privateKey);
                const decryptedData = crypt.decrypt(data.encryptedData);
                
                if (!decryptedData) {
                    throw new Error('Failed to decrypt location data');
                }
                
                const senderLocation = JSON.parse(decryptedData);
                
                // Calculate distance
                const distance = calculateDistance(
                    currentReceiverPos.coords.latitude,
                    currentReceiverPos.coords.longitude,
                    senderLocation.latitude,
                    senderLocation.longitude
                );
                
                // Update UI
                document.getElementById('distance-value').textContent = Math.round(distance);
                document.getElementById('sender-lat').textContent = senderLocation.latitude.toFixed(6);
                document.getElementById('sender-lng').textContent = senderLocation.longitude.toFixed(6);
                document.getElementById('receiver-lat').textContent = currentReceiverPos.coords.latitude.toFixed(6);
                document.getElementById('receiver-lng').textContent = currentReceiverPos.coords.longitude.toFixed(6);
                document.getElementById('tracking-updated').textContent = new Date().toLocaleTimeString();
                
                // Proximity alert
                if (distance <= 1000) {
                    document.getElementById('proximity-alert').classList.remove('hidden');
                } else {
                    document.getElementById('proximity-alert').classList.add('hidden');
                }
                
                // Update map
                if (hereMap) {
                    updateMap(senderLocation, currentReceiverPos.coords);
                }
                
            } catch (error) {
                console.error('Error tracking location:', error);
                showNotification('Failed to track location. Sender may not be sharing.', 'error');
            }
        }

        function stopTracking() {
            isTracking = false;
            if (trackingInterval) {
                clearInterval(trackingInterval);
                trackingInterval = null;
            }
            
            document.getElementById('start-tracking').classList.remove('hidden');
            document.getElementById('stop-tracking').classList.add('hidden');
            document.getElementById('distance-display').classList.add('hidden');
            document.getElementById('proximity-alert').classList.add('hidden');
            document.getElementById('map-container').classList.add('hidden');
            
            showNotification('Stopped tracking location', 'info');
        }

        // HERE Maps functionality
        function initializeMap() {
            // Note: This is a demo implementation. In production, you'd need a valid HERE API key
            document.getElementById('map-container').classList.remove('hidden');
            document.getElementById('here-map').innerHTML = `
                <div class="w-full h-64 bg-gray-200 flex items-center justify-center">
                    <div class="text-center">
                        <div class="text-gray-600 mb-2">📍 Interactive Map</div>
                        <div class="text-sm text-gray-500">HERE Maps integration</div>
                        <div class="text-xs text-gray-400 mt-1">Configure HERE_API_KEY for full functionality</div>
                    </div>
                </div>
            `;
            mapInitialized = true;
        }

        function updateMap(senderLocation, receiverLocation) {
            // This would update the HERE map with both locations
            // For now, just show that the map is being updated
            const mapDiv = document.getElementById('here-map');
            if (mapDiv) {
                const distance = calculateDistance(
                    receiverLocation.latitude,
                    receiverLocation.longitude,
                    senderLocation.latitude,
                    senderLocation.longitude
                );
                
                mapDiv.innerHTML = `
                    <div class="w-full h-64 bg-blue-50 flex items-center justify-center">
                        <div class="text-center">
                            <div class="text-blue-600 mb-2">📍 Live Tracking</div>
                            <div class="text-sm text-gray-700">Distance: ${Math.round(distance)}m</div>
                            <div class="text-xs text-gray-500 mt-1">Sender: ${senderLocation.latitude.toFixed(4)}, ${senderLocation.longitude.toFixed(4)}</div>
                            <div class="text-xs text-gray-500">You: ${receiverLocation.latitude.toFixed(4)}, ${receiverLocation.longitude.toFixed(4)}</div>
                        </div>
                    </div>
                `;
            }
        }

        // Utility functions
        function getCurrentPosition() {
            return new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                });
            });
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Earth's radius in meters
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const colors = {
                info: 'bg-blue-500',
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500'
            };
            
            notification.className = `${colors[type]} text-white px-4 py-2 rounded-lg shadow-lg mb-2 transition-all duration-300`;
            notification.textContent = message;
            
            document.getElementById('notifications').appendChild(notification);
            
            // Remove notification after 5 seconds
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (isSharing) {
                stopLocationSharing();
            }
            if (isTracking) {
                stopTracking();
            }
        });
    </script>
</body>
</html>